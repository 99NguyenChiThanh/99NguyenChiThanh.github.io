CREATE DATABASE QL_LINHKIEN
USE QL_LINHKIEN
CREATE TABLE LOAISP
(
	MALOAI CHAR (10)NOT NULL,
	TENLOAI NVARCHAR(30) NOT NULL,
	CONSTRAINT PK_LOAI PRIMARY KEY(MALOAI)
)
CREATE TABLE SANPHAM
(
	MASP CHAR(10) NOT NULL,
	TENSP NVARCHAR(100) NOT NULL,
	DONGIA INT ,
	MALOAI CHAR(10),
	SLTON INT,
	CONSTRAINT PK_SP PRIMARY KEY (MASP),
	CONSTRAINT FK_SP_LOAI FOREIGN KEY (MALOAI) REFERENCES LOAISP(MALOAI)
)
CREATE TABLE KHACHHANG 
(
	MAKH CHAR(10) NOT NULL,
	HOTEN NVARCHAR(40),
	DIACHI NVARCHAR(30) ,
	NGAYSINH DATE,
	CONSTRAINT PK_KH PRIMARY KEY (MAKH)

)
CREATE TABLE HOADON
(
	MAHD CHAR(10) NOT NULL,
	NGAYLAP DATE,
	TONGTIEN INT,
	MAKH CHAR(10),
	CONSTRAINT PK_HD PRIMARY KEY(MAHD),
	CONSTRAINT FK_HD_KH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
)
CREATE TABLE CHITIETHD
(
	MAHD CHAR(10) NOT NULL,
	MASP CHAR(10) NOT NULL,
	SLBAN INT ,
	CONSTRAINT PK_CTHD PRIMARY KEY (MAHD,MASP),
	CONSTRAINT FK_CTHD_HD FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_CTHD_SP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
)
CREATE TABLE NHACUNGCAP
(
	MANCC CHAR(10) NOT NULL,
	TENNCC NVARCHAR(40) NOT NULL,
	DIACHI NVARCHAR(40) ,
	EMAIL VARCHAR(20),
	SDT VARCHAR(10),
	CONSTRAINT PK_NCC PRIMARY KEY (MANCC)

)
CREATE TABLE PHIEUNHAP
(
	SOPN CHAR(10) NOT NULL,
	NGAYNHAP DATE,
	MANCC CHAR(10) NOT NULL,
	TONGTIENNHAP int,
	CONSTRAINT PK_PN PRIMARY KEY (SOPN),
	CONSTRAINT FK_PN_NCC FOREIGN KEY (MANCC) REFERENCES NHACUNGCAP(MANCC)
)
CREATE TABLE CHITIETPN
(
	SOPN CHAR(10) NOT NULL,
	MASP CHAR(10) NOT NULL,
	SLNHAP INT,
	DONGIANHAP INT,
	CONSTRAINT PK_CTPN PRIMARY KEY (SOPN,MASP),
	CONSTRAINT FK_CTPN_PN1 FOREIGN KEY (MASP) REFERENCES SANPHAM (MASP)
)




CREATE TRIGGER KT_SLTON
ON SANPHAM
FOR INSERT 
AS 
	IF(SELECT SLTON FROM  inserted)<0
	ROLLBACK TRAN

CREATE TRIGGER KT_SLBAN
ON CHITIETHD
FOR INSERT 
AS 
	IF(SELECT SLBAN FROM  inserted)<0
	ROLLBACK TRAN

	
CREATE TRIGGER KT_TONGTIEN
ON HOADON
FOR INSERT 
AS 
	IF(SELECT TONGTIEN FROM  inserted)<0
	ROLLBACK TRAN

CREATE TRIGGER KT_DGNHAP
ON CHITIETPN
FOR INSERT 
AS 
	IF(SELECT DONGIANHAP FROM  inserted)<0
	ROLLBACK TRAN


CREATE TRIGGER 






INSERT INTO LOAISP VALUES('MOU',N'CHUỘT')
INSERT INTO LOAISP VALUES('RAM',N'MEMORY')
INSERT INTO LOAISP VALUES('CPU',N'BỘ XỬ LÝ')
INSERT INTO LOAISP VALUES('PCX',N'CARD MÀN HÌNH')
INSERT INTO LOAISP VALUES('MAI',N'MAINBOARD')
select * from LOAISP

INSERT INTO SANPHAM VALUES('MOU001',N'Chuột máy tính A4TECH A70 ',464550,'MOU',30)
INSERT INTO SANPHAM VALUES('MOU002',N'Chuột máy tính Corsair Ironclaw',2090000,'MOU',23)
INSERT INTO SANPHAM VALUES('MOU003',N'Chuột không dây Logitech',300000,'MOU',28)
INSERT INTO SANPHAM VALUES('CPU001',N'CPU Intel Core i7-9700K (3.6GHz - 4.9GHz)',9690000,'CPU',5)
INSERT INTO SANPHAM VALUES('CPU002',N'CPU Intel Core I7-7820X (3.6GHz - 4.3GHz)',15690000,'CPU',7)
INSERT INTO SANPHAM VALUES('CPU003',N'CPU Intel Core i9-7900X (3.3GHz - 4.3GHz)',26115000,'CPU',3)
INSERT INTO SANPHAM VALUES('MAI001',N'Mainboard GIGABYTE B360 M AORUS PRO ASUS',2137500,'MAI',15)
INSERT INTO SANPHAM VALUES('MAI002',N'Mainboard GIGABYTE B360M D2V',1700500,'MAI',18)
INSERT INTO SANPHAM VALUES('MAI003',N'Mainboard ASUS P10S-X',3505500,'MAI',20)
delete from SANPHAM

SELECT * FROM SANPHAM
 SET DATEFORMAT DMY

INSERT INTO KHACHHANG VALUES('KH001',N'Huỳnh Thu Trâm ',N'Tây Ninh','09/03/1996')
INSERT INTO KHACHHANG VALUES('KH002',N'Đinh Bảo Lộc ',N'Lâm Đồng','04/02/1984')
INSERT INTO KHACHHANG VALUES('KH003',N'Trần Thanh Diệu ',N'TP HCM','03/08/1993')
INSERT INTO KHACHHANG VALUES('KH004',N'Hồ Tuấn Thành ',N'Hà Nội','12/12/1989')
INSERT INTO KHACHHANG VALUES('KH005',N'Huỳnh Ánh Kim ',N'Khánh Hòa','01/03/1992')
SELECT*FROM KHACHHANG 

SET DATEFORMAT DMY
INSERT INTO HOADON VALUES('HD001','04/12/2019',NULL,'KH001')
INSERT INTO HOADON VALUES('HD002','09/11/2018',NULL,'KH005')
INSERT INTO HOADON VALUES('HD003','02/9/2019',NULL,'KH004')
INSERT INTO HOADON VALUES('HD004','06/01/2018',NULL,'KH002')
INSERT INTO HOADON VALUES('HD005','03/12/2019',NULL,'KH001')
INSERT INTO HOADON VALUES('HD006','10/04/2018',NULL,'KH003')
INSERT INTO HOADON VALUES('HD007','11/09/2018',NULL,'KH002')
INSERT INTO HOADON VALUES('HD008','11/03/2018',NULL,'KH003')
						  SELECT*FROM HOADON
INSERT INTO CHITIETHD VALUES('HD001','MOU001',2)
INSERT INTO CHITIETHD VALUES('HD002','MOU002',1)
INSERT INTO CHITIETHD VALUES('HD003','MOU003',6)
INSERT INTO CHITIETHD VALUES('HD004','CPU001',5)
INSERT INTO CHITIETHD VALUES('HD005','CPU002',6)
INSERT INTO CHITIETHD VALUES('HD006','CPU003',3)
INSERT INTO CHITIETHD VALUES('HD006','MAI001',1)
INSERT INTO CHITIETHD VALUES('HD007','MAI002',1)
INSERT INTO CHITIETHD VALUES('HD007','MAI003',2)
INSERT INTO CHITIETHD VALUES('HD007','MOU001',1)
INSERT INTO CHITIETHD VALUES('HD008','CPU001',2)
SELECT*FROM CHITIETHD

INSERT INTO NHACUNGCAP VALUES ('NCC01','Kingston',N'Tân Phú',null,'0981414329')
INSERT INTO NHACUNGCAP VALUES ('NCC02','KingMax',N'Bình Thạnh',null,'0125932498')
INSERT INTO NHACUNGCAP VALUES ('NCC03','ASUS',N'Hà Nội',null,'0125915963')
INSERT INTO NHACUNGCAP VALUES ('NCC05','GIGABYTE',N'Bình Dương',null,'0354986284')
INSERT INTO NHACUNGCAP VALUES ('NCC06','Intel',N'Bình Dương',null,'0359898632')
INSERT INTO NHACUNGCAP VALUES ('NCC04','Logitech',N'Đà Nẵng',null,'098272942')
select * from NHACUNGCAP

INSERT INTO PHIEUNHAP VALUES ('PN01','01/02/2019','NCC02',NULL)
INSERT INTO PHIEUNHAP VALUES ('PN02','02/03/2019','NCC06',NULL)
INSERT INTO PHIEUNHAP VALUES ('PN03','01/11/2018','NCC04',NULL)
INSERT INTO PHIEUNHAP VALUES ('PN05','02/04/2019','NCC03',NULL)
INSERT INTO PHIEUNHAP VALUES ('PN04','01/03/2019','NCC02',NULL)
INSERT INTO PHIEUNHAP VALUES ('PN06','01/05/2019','NCC01',NULL)
SELECT * FROM PHIEUNHAP 
INSERT INTO CHITIETPN VALUES('PN01','MOU001',NULL,NULL)
INSERT INTO CHITIETPN VALUES('PN02','MAI001',NULL,NULL)
INSERT INTO CHITIETPN VALUES('PN03','CPU002',NULL,NULL)
INSERT INTO CHITIETPN VALUES('PN01','CPU001',NULL,NULL)
INSERT INTO CHITIETPN VALUES('PN05','MOU002',NULL,NULL)
select * FROM CHITIETPN


------------------



ALTER DATABASE QL_LINHKIEN
SET RECOVERY FULL


BACKUP DATABASE  QL_LINHKIEN
TO DISK = 'G:\QL_LINHKIEN_FULL.BAK'
WITH INIT


INSERT INTO CHITIETPN VALUES('PN04','CPU003',NULL,NULL)


BACKUP DATABASE  QL_LINHKIEN
TO DISK = 'G:\QL_LINHKIEN_DIFF.BAK'
WITH DIFFERENTIAL;

INSERT INTO KHACHHANG VALUES('KH006',N'Huỳnh Ngọc Trí ',N'Khánh Hòa','01/09/1992')

BACKUP LOG QL_LINHKIEN
TO DISK='G:\QL_LINHKIEN_LOG.TRN'


RESTORE DATABASE QL_LINHKIEN
FROM DISK='G:\QL_LINHKIEN_FULL.BAK'
WITH NORECOVERY


RESTORE DATABASE QL_LINHKIEN
FROM DISK='G:\QL_LINHKIEN_DIFF.BAK'
WITH NORECOVERY

RESTORE DATABASE QL_LINHKIEN
FROM DISK='G:\QL_LINHKIEN_LOG.TRN'
WITH RECOVERY



SP_ADDLOGIN 'HUUTRONG','123456','QL_LINHKIEN'
SP_ADDLOGIN 'AB','123456','QL_LINHKIEN'
SP_DROPLOGIN 'HUUTRONG'

SP_ADDUSER 'HUUTRONG','HUUTRONG'


--Gán người dùng HUUTRONG vào nhóm sysadmin
SP_ADDSRVROLEMEMBER 'HUUTRONG','SYSADMIN'

--TẠO NHÓM QUYỀN CÓ TÊN LÀ XEM DỮ LIỆU
SP_ADDROLE 'XEM_DU_LIEU'
--HỦY NHÓM QUYỀN XEM_DU_LIEU
SP_DROPROLE 'XEM_DU_LIEU'
--ADD NHÓM QUYENF XEM_DU_LIEU CHO NGƯỜI DUNG TASY CO TEN DANG NHÂP AB
SP_ADDUSER 'AB','TANSY'
SP_ADDROLEMEMBER 'XEM_DU_LIEU','TANSY'
---XÓA NGƯỜI DÙNG TANSYY RA KHOI NHÓM QUYỀN XEM_DU_LIEU
SP_DROPROLEMEMBER'XEM_DU_LIEU','TANSY'

--CẤP CHO NGƯỜI DUNG TANSY CÓ QUYỀN THỰC THI CÁC CÂU LỆNH SELECT INSERT , UPDATE TRÊN BẢNG SANPHAM
GRANT INSERT, SELECT, UPDATE
ON SANPHAM
TO TANSY

--CẤP CHO NGƯỜI DUNG TANSY QUYỀN XEM ( HỌ TÊN, NGÀY SINH,DỊA CHỈ CỦA BẢNG KHÁCH HÀNG)
GRANT SELECT(HOTEN,NGAYSINH,DIACHI)
ON KHACHHANG
TO TANSY
--
CHO PHÉP NGƯỜI DÙNG HUUTRONG XEM BANG HÓA ĐƠN , CÓ THỂ CHUYỂN TIẾP QUYỀN NÀY CHO NGƯỜI DÙNG KHÁC
GRANT SELECT
ON HOADON
TO HUUTRONG
WITH GRANT OPTION

-- CẤP QUYỀN SSELECT TRÊN BẢNG PHIẾU NHẬP CHO NHÓM QUYÊN XEM_DU_LIEU
GRANT SELECT
ON PHIEUNHAP
TO XEM_DU_LIEU
WITH GRANT OPTION


--THU HỒI QUYỀN INNSERT TRÊN BẢNG TRÊN BẢNG SANPHAM  ĐỐI VỚI NGƯỜI DÙNG TANSY 
REVOKE INSERT
ON SANPHAM
FROM TANSY 
-- CHỈ THU HỒI QUYỀN XEM CỘT DIACHI CỦA TABLE KHACHHANG ĐỐI VỚI NGƯỜI DUNG TANSY 	
REVOKE SELECT(DIACHI)
ON KHACHHANG
FROM TANSY 

--NGƯỜI DUNG TANSY CẤP QUYỀN SELECT ĐỮ LIỆU BẢN SINH VIÊN CHO  NGƯỜI DUNG HUUTRONG
GRANT SELECT,INSERT 
ON SANPHAM
TO HUUTRONG

REVOKE SELECT ,INSERT 
ON SANPHAM
TO HUUTRONG


--CẤP QUYỀN SELECT TRÊN BẢN NHACCUNGCAP CHO NGƯƠI DUNG HUUTRONG
GRANT  SELECT
ON NHACUNGCAP
TO HUUTRONG
WITH GRANT OPTION
--NGƯỜI DÙNG HUUTRONG CẤP QUYỀN SELECT CHO NGƯỜI DUNG TANSY
GRANT SELECT
ON NHACUNGCAP
TO TANSY 
-- THU HỒI QUYỀN SELECT CỦA USER HUUTRONG
REVOKE SELECT
ON NHACUNGCAP
FROM HUUTRONG
CASCADE 

--CHỈ THU HỒI QUYỀN CHUYỂN TIẾP
REVOKE GRANT OPTION FOR SELECT
ON NHACUNGCAP
FROM HUUTRONG
CASCADE

--CẤP QUYỀN SELECT TRÊN BẢNG HOADON  CHO NHOM QUYỀN XEM_DU_LIEU
GRANT  SELECT
ON HOADON
TO XEM_DU_LIEU
WITH GRANT OPTION

GRANT SELECT
ON HOADON
TO HUUTRONG
AS XEM_DU_LIEU

REVOKE SELECT
ON HOADON
FROM HUUTRONG
AS XEM_DU_LIEU